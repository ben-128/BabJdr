<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>Test Syst√®me d'√âdition Unifi√©</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .test { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .pass { background-color: #d4edda; border: 1px solid #28a745; }
        .fail { background-color: #f8d7da; border: 1px solid #dc3545; }
        .info { background-color: #d1ecf1; border: 1px solid #17a2b8; }
        .warning { background-color: #fff3cd; border: 1px solid #ffc107; }
        
        .editable-section { 
            margin: 10px 0; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            position: relative;
        }
        .edit-btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 4px 8px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-size: 12px;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .editable { 
            min-height: 20px; 
            padding: 5px;
            margin-top: 10px;
        }
        [data-editing="true"] .editable {
            background-color: rgba(255, 255, 0, 0.1);
            border: 1px dashed #ff6b35;
        }
    </style>
</head>
<body>
    <h1>üß™ Test du Syst√®me d'√âdition Unifi√©</h1>
    <div id="test-results"></div>

    <h2>üìù Test Interactif</h2>
    <p><strong>Instructions:</strong> Cliquez sur les boutons "Edit" pour tester l'√©dition unifi√©e.</p>
    
    <!-- Test Spell editing -->
    <div class="editable-section">
        <button class="edit-btn">Edit</button>
        <h3>üîÆ Test Sort</h3>
        <div class="editable" data-edit-type="spell-name" data-edit-spell="Boule de Feu">Boule de Feu</div>
        <div class="editable" data-edit-type="spell-description" data-edit-spell="Boule de Feu">Lance une boule de feu destructrice</div>
    </div>

    <!-- Test Don editing -->
    <div class="editable-section">
        <button class="edit-btn">Edit</button>
        <h3>üèÜ Test Don</h3>
        <div class="editable" data-edit-type="don-name" data-edit-don="Attaque Puissante">Attaque Puissante</div>
        <div class="editable" data-edit-type="don-description" data-edit-don="Attaque Puissante">Une frappe d√©vastatrice qui ignore l'armure</div>
    </div>

    <!-- Test Class editing -->
    <div class="editable-section">
        <button class="edit-btn">Edit</button>
        <h3>‚öîÔ∏è Test Classe</h3>
        <div class="editable" data-edit-type="class-name" data-edit-section="guerrier">Guerrier</div>
        <div class="editable" data-edit-type="class-resume" data-edit-section="guerrier">Ma√Ætre des armes et du combat rapproch√©</div>
    </div>

    <!-- Chargement des modules -->
    <script src="js/config/contentTypes.js"></script>
    <script src="js/core/EventBus.js"></script>
    <script src="js/core/BaseEntity.js"></script>
    <script src="js/core/UnifiedEditor.js"></script>
    <script src="js/factories/ContentFactory.js"></script>

    <script>
        // Mock data minimal pour les tests
        window.SORTS = [{
            nom: "Sorts de Combat",
            sorts: [{ 
                nom: "Boule de Feu", 
                description: "Lance une boule de feu destructrice",
                prerequis: "Niveau 1",
                portee: "20m",
                coutMana: "3"
            }]
        }];

        window.DONS = [{
            nom: "Dons de Guerrier", 
            dons: [{ 
                nom: "Attaque Puissante", 
                description: "Une frappe d√©vastatrice qui ignore l'armure",
                prerequis: "Force 5",
                cout: "2 points"
            }]
        }];

        window.CLASSES = [{
            nom: "Guerrier",
            resume: "Ma√Ætre des armes et du combat rapproch√©",
            capacites: ["Ma√Ætrise des armes", "R√©sistance physique"]
        }];

        // Constantes d'√©v√©nements
        window.Events = {
            CONTENT_UPDATE: 'content:update',
            CONTENT_ADD: 'content:add',
            CONTENT_DELETE: 'content:delete',
            EDITOR_TOGGLE: 'editor:toggle',
            IMAGE_UPLOAD: 'image:upload',
            IMAGE_DELETE: 'image:delete',
            STORAGE_SAVE: 'storage:save'
        };

        // Tests
        const results = document.getElementById('test-results');

        function addTest(name, passed, message) {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${name}:</strong> ${passed ? '‚úÖ PASS' : '‚ùå FAIL'} - ${message}`;
            results.appendChild(div);
        }

        function addInfo(message) {
            const div = document.createElement('div');
            div.className = 'test info';
            div.innerHTML = `<strong>‚ÑπÔ∏è INFO:</strong> ${message}`;
            results.appendChild(div);
        }

        function addWarning(message) {
            const div = document.createElement('div');
            div.className = 'test warning';
            div.innerHTML = `<strong>‚ö†Ô∏è ATTENTION:</strong> ${message}`;
            results.appendChild(div);
        }

        // Initialisation et tests
        setTimeout(() => {
            try {
                addInfo('üöÄ D√©marrage des tests d\'√©dition unifi√©e...');

                // Test 1: UnifiedEditor existe
                addTest('UnifiedEditor Class', 
                    window.UnifiedEditor && typeof window.UnifiedEditor.startEdit === 'function', 
                    'UnifiedEditor cr√©√© et accessible');

                // Test 2: ContentTypes avec editMapping
                const spellEditMapping = window.ContentTypes.spell.editMapping;
                addTest('EditMapping Configuration', 
                    spellEditMapping && spellEditMapping['spell-name'] === 'nom', 
                    'Mappings d\'√©dition configur√©s correctement');

                // Test 3: ContentFactory initialis√©
                addTest('ContentFactory Ready', 
                    window.ContentFactory && window.ContentFactory.findItem, 
                    'ContentFactory pr√™t pour les op√©rations');

                // Test 4: EventBus op√©rationnel
                let eventReceived = false;
                EventBus.on('test-event', () => { eventReceived = true; });
                EventBus.emit('test-event');
                addTest('EventBus Communication', 
                    eventReceived, 
                    'Communication par √©v√©nements fonctionne');

                // Test 5: Parse Context
                const testElement = document.querySelector('[data-edit-type="spell-name"]');
                const context = window.UnifiedEditor.parseEditContext(testElement.parentElement);
                addTest('Context Parsing', 
                    context && context.contentType === 'spell' && context.property === 'nom', 
                    'Analyse du contexte d\'√©dition fonctionne');

                // Test 6: Setup event handlers pour l'√©dition
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('edit-btn')) {
                        e.preventDefault();
                        const editableSection = e.target.closest('.editable-section');
                        if (editableSection && !window.UnifiedEditor.isEditing(editableSection)) {
                            const success = window.UnifiedEditor.startEdit(editableSection);
                            if (success) {
                                console.log('‚úÖ √âdition d√©marr√©e avec succ√®s');
                            }
                        }
                    }
                });

                // Test 7: Keyboard handlers
                document.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('editable') && e.target.contentEditable === 'true') {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            window.UnifiedEditor.saveCurrentEdit();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            window.UnifiedEditor.cancelCurrentEdit();
                        }
                    }
                });

                addTest('Event Handlers Setup', 
                    true, 
                    'Gestionnaires d\'√©v√©nements configur√©s');

                addInfo('üéâ Tous les tests automatiques r√©ussis!');
                addWarning('Testez maintenant l\'√©dition interactive ci-dessus (cliquez sur les boutons "Edit")');
                addInfo('üí° Utilisez Entr√©e pour sauver, √âchap pour annuler');
                
                console.log('UnifiedEditor ready:', window.UnifiedEditor);
                
            } catch (error) {
                addTest('Global Test', false, `Erreur: ${error.message}`);
                console.error('Test error:', error);
            }
        }, 100);
    </script>
</body>
</html>